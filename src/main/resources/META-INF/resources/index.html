<!DOCTYPE html>
<html lang="en">
<head>
    <title>BBOP MMO ARCADE</title>
    <meta charset="UTF-8">
    <!-- https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser-arcade-physics.min.js -->
    <script src="js/optional.js"></script>
    <script src="js/phaser-arcade-physics.min.js"></script>
    <script src="js/user-id.js"></script>
    <script src="js/game-config.js"></script>
    <script src="js/uuid.js"></script>
    <script src="js/get-cookie.js"></script>
    <script src="js/hud.js"></script>
    <script src="js/sounds.js"></script>
    <script src="js/server.js"></script>
    <script src="js/transform.js"></script>
    <script src="js/player.js"></script>
    <script src="js/player-inputs.js"></script>
    <script src="js/bolts.js"></script>
    <script src="js/scoreboard.js"></script>
    <script src="js/event-queue-consumer.js"></script>
    <script src="js/event-queue-producer.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/bbop.proto.js"></script>
</head>
<body>

<script>


    const USER = new UserId(getCookie, uuid).start();


    const QUEUES = {
        'event': new QueueConsumer('event', 'event'),
        'command': new QueueConsumer('directedCommand', 'command'),
        'move': new QueueProducer(sendMessage).start(),
    };

    function gameScene() {
        return game.scene.scenes[0];
    }

    function getSounds() {
        return Sounds.get(gameScene(), GameConfig.get());
    }

    function getHud() {
        return Hud.get(gameScene(), GameConfig.get());
    }

    function getPlayerInputs() {
        return PlayerInputs.get(gameScene());
    }

    const getPlayers = (function () {
        let userSet = false;

        return function () {
            const players = Players.get(
                gameScene(),
                getSounds(),
                GameConfig.get(),
                getHud(),
                transform,
                QUEUES,
                getPlayerInputs(),
                getServer);
            if (!userSet) {
                userSet = true;
                return players
                    .follow(USER.get())
                    .addControllableUser(USER.get());
            }
            return players;
        }
    })();

    function getBolts() {
        return Bolts.get(
            getServer(),
            gameScene(),
            getPlayers(),
            GameConfig.get(),
            transform,
            getSounds(),
            QUEUES,
            getPlayerInputs());
    }

    function getServer() {
        return Server.get(USER.get(), QUEUES, location.host, ProtoProcessor);
    }

    function sendMessage(value) {
        getServer().sendMessage(value);
    }


    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth - 20,
        height: window.innerHeight - 20,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 0},
                isPaused: true
            }
        },
        scene: {
            preload: preload,
            create: create
        }
    };

    const game = new Phaser.Game(config);

    function preload() {
        //this.load.setBaseURL('http://labs.phaser.io');

        this.load.spritesheet('ship', 'assets/ship3-sheet.png', {frameWidth: 128, frameHeight: 128});
        this.load.spritesheet('thrust', 'assets/thrust3-sheet.png', {frameWidth: 64, frameHeight: 64});
        this.load.spritesheet('shockwave', 'assets/shockwave1-sheet.png', {frameWidth: 272, frameHeight: 272});
        this.load.spritesheet('fire-effect', 'assets/fire-effect.png', {frameWidth: 128, frameHeight: 128});

        this.load.atlas('fontatlas', 'assets/font/font2.png', 'assets/font/font2.json');

        this.load.xml('atariXML', 'assets/font/atari-sunset.xml');

        this.load.image('bolt', 'assets/white.png');
        this.load.image('wake', 'assets/white.png');

        this.load.image('gridf', 'assets/gridf.png');
        this.load.image('gridb', 'assets/gridb.png');

        getSounds().get('fire1').preload();
        getSounds().get('explosion1').preload();
        this.load.audio(`death1`, `assets/sound/death1.mp3`);

    }

    const transform = Transform.get(GameConfig.get());


    function create() {

        this.cameras.main.setBounds(GameConfig.get().world.min.x, GameConfig.get().world.min.y, GameConfig.get().world.width, GameConfig.get().world.height);
        this.physics.world.setBounds(GameConfig.get().world.min.x, GameConfig.get().world.min.y, GameConfig.get().world.width, GameConfig.get().world.height);


        this.add.image(GameConfig.get().world.min.x, GameConfig.get().world.min.y, 'gridb')
            .setOrigin(0)
            .setScale(1)
            .setDepth(GameConfig.get().add('background.depth', -2));

        this.add.image(GameConfig.get().world.min.x, GameConfig.get().world.min.y, 'gridf')
            .setOrigin(0)
            .setScale(1)
            .setDepth(GameConfig.get().background.depth);


        this.cameras.main.setDeadzone(GameConfig.get().camera.deadZone, GameConfig.get().camera.deadZone);

        //create singletons
        getPlayers();
        getBolts();
        getServer();

        Scoreboard.get(this, getPlayers(), 0, 0)
            .setAlpha(GameConfig.get().hud.alpha)
            .setupEventQueue(QUEUES.event)
            .setDepth(GameConfig.get().hud.depth);

        Phaser.GameObjects.BitmapText.ParseFromAtlas(this, 'font', 'fontatlas', 'atari-sunset', 'atariXML');


        const AI = (function () {
            const urlParams = new URLSearchParams(window.location.search);
            if ('true' === urlParams.get('ai')) {
                return new AiBot(USER.get(), getServer(), getPlayers(), transform, GameConfig.get());
            }
            return {
                'start': () => {
                }, 'stop': () => {
                }
            };
        })();
        AI.start();
    }


</script>

</body>
</html>
